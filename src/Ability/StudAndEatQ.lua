---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Bergi.
--- DateTime: 29.10.2020 16:32
---
do
    TimerStart(CreateTimer(), 0.11, false, function()
        InitStunPerDie()
        InitSpellEat()
        SoundAttack1 = CreateSound("Sound\\Units\\Combat\\MetalHeavySliceFlesh1", false, true, true, 0, 0, "MissilesEAX")
        SetSoundParamsFromLabel(SoundAttack1, "MetalHeavySliceFlesh")
        SetSoundDuration(SoundAttack1, 853)
        SetSoundVolume(SoundAttack1, 250)
        SoundAttack2 = CreateSound("Sound\\Units\\Combat\\MetalHeavySliceFlesh2", false, true, true, 0, 0, "MissilesEAX")
        SetSoundParamsFromLabel(SoundAttack2, "MetalHeavySliceFlesh")
        SetSoundDuration(SoundAttack2, 853)
        SetSoundVolume(SoundAttack2, 250)
    end)
end
function InitStunPerDie()
    local DamageTrigger = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        TriggerRegisterPlayerUnitEvent(DamageTrigger, Player(i), EVENT_PLAYER_UNIT_DAMAGING) -- До вычета брони
    end
    TriggerAddAction(DamageTrigger, function()

        local damage     = GetEventDamage() -- число урона
        if damage < 1 then return end
        local eventId         = GetHandleId(GetTriggerEventId())
        local isEventDamaging = eventId == GetHandleId(EVENT_PLAYER_UNIT_DAMAGING)
        local target          = GetTriggerUnit() -- тот кто получил урон
        local caster          = GetEventDamageSource() -- тот кто нанёс урон


        if isEventDamaging then
            TimerStart(CreateTimer(), 0.11, false, function()
                if UnitAlive(target) and GetUnitStatePercent(target,UNIT_STATE_LIFE,UNIT_STATE_MAX_LIFE)<=30 and GetOwningPlayer(target)~=Player(0)  and not IsUnitType(target,UNIT_TYPE_UNDEAD) then --and GetUnitLevel(target)<=5
                    local savedOwner=GetOwningPlayer(target)
                    StunUnit(target,3.5)
                    UnitAddType(target,UNIT_TYPE_UNDEAD)
                    SetUnitOwner(target,Player(PLAYER_NEUTRAL_PASSIVE),true)
                    SetUnitAnimation(target,"death")
                    RemoveGuardPosition(target)
                    -- print("юнита можно съесть?")
                    TimerStart(CreateTimer(), 3.5, false, function()
                        UnitRemoveType(target,UNIT_TYPE_UNDEAD)
                        ResetUnitAnimation(target)
                        SetUnitOwner(target,savedOwner,true)
                    end)

                end
            end)

            if GetUnitTypeId(caster)==FourCC("Hpal") and IsUnitInRange(caster,target,200) then
                --print("звук удара")
                local tl = Location(GetUnitXY(target))
                local r=GetRandomInt(1,2)
                if r==1 then
                    PlaySoundAtPointBJ(SoundAttack1, 100, tl, 0)
                else
                    PlaySoundAtPointBJ(SoundAttack2, 100, tl, 0)
                end
                RemoveLocation(tl)
                if not IsUnitType(target,UNIT_TYPE_UNDEAD) then
                    AddSpecialEffect("Objects\\Spawnmodels\\NightElf\\NightElfBlood\\NightElfBloodChimaera.mdl",GetUnitXY(target))
                    --print("Кровь")
                end
            end
        end
    end)
end

function InitSpellEat()
    local SpellTrigger = CreateTrigger()
    for i = 0, bj_MAX_PLAYER_SLOTS - 1 do
        local player = Player(i)
        TriggerRegisterPlayerUnitEvent(SpellTrigger, player, EVENT_PLAYER_UNIT_SPELL_CAST)
    end
    TriggerAddAction(SpellTrigger, function()
        if GetSpellAbilityId() == FourCC('A002') then -- пожирание
            local target=GetSpellTargetUnit()
            if IsUnitPaused(target) then
                ShowUnit(target,false)
                print("Был ли баг двнойной смерти?")
            end
        end
    end)
end